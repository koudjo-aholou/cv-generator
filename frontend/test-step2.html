<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Test Ã‰tape 2</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { background: #f0f0f0; }
        #log {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            border: 2px solid #0073b1;
            padding: 15px;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            z-index: 9999;
        }
        #log p { margin: 5px 0; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }

        /* Force les Ã©diteurs Ã  Ãªtre visibles pour debug */
        experience-editor,
        education-editor {
            border: 3px dashed orange !important;
            min-height: 100px !important;
            margin: 20px 0 !important;
            padding: 20px !important;
        }
    </style>
</head>
<body>
    <div id="log">
        <h3>ğŸ“Š Debug Log</h3>
        <button onclick="testManualEvent()">ğŸ§ª Ã‰mettre 'data-parsed' manuellement</button>
        <button onclick="logComponentsState()">ğŸ“‹ Ã‰tat des composants</button>
        <hr>
        <div id="log-content"></div>
    </div>

    <div class="container">
        <header>
            <h1>ğŸ§ª Test Ã‰tape 2 - Ã‰diteurs</h1>
        </header>

        <main style="padding: 2rem;">
            <div class="card">
                <h2>Ã‰diteur d'expÃ©riences</h2>
                <experience-editor id="exp-editor"></experience-editor>
            </div>

            <div class="card">
                <h2>Ã‰diteur de formations</h2>
                <education-editor id="edu-editor"></education-editor>
            </div>
        </main>
    </div>

    <script type="module">
        const logContent = document.getElementById('log-content');

        function log(message, type = 'info') {
            const p = document.createElement('p');
            p.className = type;
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContent.appendChild(p);
            console.log(message);
            logContent.scrollTop = logContent.scrollHeight;
        }

        log('ğŸš€ Page chargÃ©e', 'info');

        // Import main.js pour initialiser l'app
        try {
            await import('./js/main.js');
            log('âœ… main.js importÃ©', 'success');
        } catch(e) {
            log(`âŒ Erreur import main.js: ${e.message}`, 'error');
        }

        // Ã‰couter l'Ã©vÃ©nement data-parsed
        let eventCount = 0;
        document.addEventListener('data-parsed', async (e) => {
            eventCount++;
            log(`ğŸ¯ Ã‰vÃ©nement 'data-parsed' reÃ§u (${eventCount}x)`, 'success');

            // VÃ©rifier les donnÃ©es
            const { cvStateService } = await import('./js/services/state/cvStateService.js');
            const data = cvStateService.getParsedData();

            if (data) {
                log(`ğŸ“¦ DonnÃ©es disponibles: ${Object.keys(data).join(', ')}`, 'info');
                log(`   - positions: ${data.positions?.length || 0} items`, 'info');
                log(`   - education: ${data.education?.length || 0} items`, 'info');
            } else {
                log('âš ï¸ Pas de donnÃ©es aprÃ¨s Ã©vÃ©nement', 'error');
            }

            // VÃ©rifier l'Ã©tat des Ã©diteurs
            setTimeout(() => window.logComponentsState(), 100);
        });

        // Fonction pour tester l'Ã©mission manuelle
        window.testManualEvent = async function() {
            log('ğŸ”¨ CrÃ©ation de donnÃ©es de test...', 'info');

            const { cvStateService } = await import('./js/services/state/cvStateService.js');

            // CrÃ©er des donnÃ©es factices
            cvStateService.setParsedData({
                positions: [
                    { company: 'Test Company', title: 'Test Job', start_date: '2020', end_date: '2023' }
                ],
                education: [
                    { school: 'Test School', degree: 'Test Degree', start_date: '2015', end_date: '2019' }
                ],
                skills: ['JavaScript', 'React'],
                languages: [],
                certifications: [],
                profile: { name: 'Test User' }
            });

            log('ğŸ“¤ Ã‰mission de l\'Ã©vÃ©nement data-parsed...', 'info');
            document.dispatchEvent(new CustomEvent('data-parsed'));
        };

        // Fonction pour logger l'Ã©tat des composants
        window.logComponentsState = function() {
            const expEditor = document.getElementById('exp-editor');
            const eduEditor = document.getElementById('edu-editor');

            log('--- Ã‰tat des composants ---', 'info');

            if (expEditor) {
                log(`experience-editor:`, 'info');
                log(`  - display: ${expEditor.style.display || 'default'}`, 'info');
                log(`  - innerHTML: ${expEditor.innerHTML.length} chars`, 'info');
                log(`  - offsetHeight: ${expEditor.offsetHeight}px`, 'info');
                log(`  - experiences: ${expEditor.experiences?.length || 0}`, 'info');
            }

            if (eduEditor) {
                log(`education-editor:`, 'info');
                log(`  - display: ${eduEditor.style.display || 'default'}`, 'info');
                log(`  - innerHTML: ${eduEditor.innerHTML.length} chars`, 'info');
                log(`  - offsetHeight: ${eduEditor.offsetHeight}px`, 'info');
                log(`  - educations: ${eduEditor.educations?.length || 0}`, 'info');
            }
        };

        // Ã‰tat initial aprÃ¨s 1 seconde
        setTimeout(() => {
            log('ğŸ” VÃ©rification de l\'Ã©tat initial...', 'info');
            logComponentsState();
        }, 1000);
    </script>
</body>
</html>
